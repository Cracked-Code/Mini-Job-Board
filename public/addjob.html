<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Tracker 2000</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&family=Roboto+Slab:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <nav>
        <a href="./index.html"><i class="fa-solid fa-house"></i></a>
    </nav>
    <h1>Job Portal</h1>
</head>
<body>
    <main>
        <div class="buttons">
        </div>
        <div id="addjob" style="display: block;" class="buttons" >
            <h3>Add new job</h3>
            <input type="text" id="newjobtitle" required placeholder="Job Title">
            <input type="text" id="newjobdesc" required placeholder="Job Desc">
            <input type="date" id="newjobdate" required placeholder="Job Date placeholder">
            <button onclick="addJob()"> Submit</button>
            <!-- <button onclick="loadJobs()"><i class="fa-solid fa-arrows-rotate"></i></button> -->
        </div>
        <div class="buttons">
            <button onclick="loadJobs()"><i class="fa-solid fa-arrows-rotate"></i></button>
            <button onclick="showeditJob()">Edit <i class="fa-solid fa-pen-to-square"></i></button>
        </div>

        <div id="jobsList" class = "maindiv">
            <table id="jobsTable">
                <thead>
                    <tr>
                        <th>Job Name</th>
                        <th>Job Description</th>
                        <th>Date Applied</th>
                        <th>Status</th>
                        <th id= "editcol" style="display: none;">Edit</th>
                        <th id="deletecol" style="display:none;">Delete</th>
                    </tr>
                </thead>
                <tbody id="jobsTableBody" >
                <!-- Jobs will be inserted here by JavaScript -->
                    <tr style="padding-top: 1rem;">
                        <td colspan="4" style="text-align: center;">No jobs loaded yet. Click "Get Jobs"</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
    </main>
        <script>
            async function loadJobs() {
                // Fetch from backend
                const response = await fetch('/jobs', {
                    method : 'GET',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const jobs = await response.json();
                if (response.ok) {console.log('ALL Jobs Loaded IN!')
                    displayJobs(jobs)
                }
                else {alert("ERROR")}
            }
            function displayJobs(jobs) {
                const tableBody = document.getElementById('jobsTableBody');
                // Clear existing rows
                tableBody.innerHTML = '';                                
                // Create a row for each job
                jobs.forEach(job => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${job.job_title}</td>
                        <td>${job.job_description}</td>
                        <td>${new Date(job.date_applied).toLocaleDateString()}</td>
                        <td id='status'>${job.accepted ? '✅ Accepted' : '⏳ Pending'}</td>
                        <td class="edit-cell" style="display: none"> <button onclick="editJob(${job.id}, ${job.accepted})">
                            Button</button> </td>
                        <td class="delete-cell" style="display: none"> <button onclick="deleteJob(${job.id})">
                            DELETE</button> </td>       
                    `;
                    tableBody.appendChild(row);
                });
        }
        </script>
        <script>
            async function addJob() {
                const newjobtittleadded= document.getElementById('newjobtitle').value
                const newjobdescadded = document.getElementById('newjobdesc').value
                const newjobdateAdded = document.getElementById('newjobdate').value
                const addjob = await fetch('/jobs', {
                    method : 'POST',
                    headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('token')},
                    body: JSON.stringify({job_title:newjobtittleadded, job_description:newjobdescadded, date_applied:newjobdateAdded})
                })
                const check = await addjob.json()
                if (addjob.ok) {
                    console.log("Added job")
                    loadJobs()
                } else {console.log("Nope")}
            }

            function showeditJob() {
                // Get the header
                const header = document.getElementById('editcol');  
                const header2 = document.getElementById('deletecol');  
                // Get all cells in the edit column
                const cells = document.querySelectorAll('.edit-cell');
                const cells2 = document.querySelectorAll('.delete-cell');
                // Toggle visibility
                //THis is for the edit coloumn
                if (header.style.display === 'none') {
                    // Show
                    header.style.display = 'table-cell';
                    cells.forEach(cell => {
                        cell.style.display = 'table-cell';
                    });
                } else {
                    // Hide
                    header.style.display = 'none';
                    cells.forEach(cell => {
                        cell.style.display = 'none';
                    });
                }
                //This is for the delete coloumn
                 if (header2.style.display === 'none') {
                    // Show
                    header2.style.display = 'table-cell';
                    cells2.forEach(cell => {
                        cell.style.display = 'table-cell';
                    });
                } else {
                    // Hide
                    header2.style.display = 'none';
                    cells2.forEach(cell => {
                        cell.style.display = 'none';
                    });
                }
            }
            async function editJob(job_id, currentStatus) {
                if (currentStatus == 0 ) {currentStatus = 1}
                else {currentStatus = 0}
                const editdajob = await fetch(`/jobs/${job_id}`, {
                    method : 'PUT',
                    headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('token')},
                    body: JSON.stringify({accepted:currentStatus})
                    })
                const check = await editdajob.json()
                if (editdajob.ok) {
                    console.log("Edited Job!")
                    
                    loadJobs()
                    showeditJob()
                } else {console.log('Error :()')}
            }

            async function deleteJob(job_id) {
                const deletethejob = await fetch(`/jobs/${job_id}`,{
                    method : 'DELETE',
                    headers: {'Content-Type': 'application/json','Authorization': 'Bearer ' + localStorage.getItem('token')},
                    body :JSON.stringify({id:job_id })
                })
                const check= await deletethejob.json()
                if (deletethejob.ok) {
                    console.log("Succeful deleted job")
                    loadJobs()
                    showeditJob()
                } else {
                    console.log("Uh oh, couldnt delete job")
                }

            }
        </script>   


</body>
</html>